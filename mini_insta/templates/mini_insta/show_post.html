<!-- File: mini_insta/templates/mini_insta/show_post.html-->
<!-- Author: Louise Lee, llouise@bu.edu, 09/30/2025 -->
<!-- Description: Displays a single post from a profile -->

{% extends 'mini_insta/base.html' %}

{% block content %}
<h1>Post: @{{ post.profile.username }}</h1>

<!-- Only show Update/Delete if this is the logged-in user's post -->
{% if request.user.is_authenticated and post.profile.user == request.user %}
  <p>
    <a href="{% url 'update_post' post.pk %}" class="btn">Update</a>
    <a href="{% url 'delete_post' post.pk %}" class="btn delete">Delete</a>
  </p>
{% endif %}

<ul class="photos-grid">
  {% for photo in post.get_all_photos %}
    {% with url=photo.get_image_url %}
      <li class="photo-card">
        {% if url %}
          <img src="{{ url }}" alt="Post photo">
        {% else %}
          <img src="https://media.istockphoto.com/id/1472933890/vector/no-image-vector-symbol-missing-available-icon-no-gallery-for-this-moment-placeholder.jpg?s=612x612&w=0&k=20&c=Rdn-lecwAj8ciQEccm0Ep2RX50FCuUJOaEM8qQjiLL0=" alt="No post image">
        {% endif %}
      </li>
    {% endwith %}
  {% empty %}
    <li class="photo-card">
      <img src="https://media.istockphoto.com/id/1472933890/vector/no-image-vector-symbol-missing-available-icon-no-gallery-for-this-moment-placeholder.jpg?s=612x612&w=0&k=20&c=Rdn-lecwAj8ciQEccm0Ep2RX50FCuUJOaEM8qQjiLL0=" alt="No post image">
    </li>
  {% endfor %}
</ul>

<!-- Like/Unlike buttons (only show if logged in and not your own post) -->
{% if request.user.is_authenticated and user_profile and user_profile != post.profile %}
  <div class="like-actions">
    {% if has_liked %}
      <form method="POST" action="{% url 'unlike_post' post.pk %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn unlike-btn">♥ Unlike</button>
      </form>
    {% else %}
      <form method="POST" action="{% url 'like_post' post.pk %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="btn like-btn">♡ Like</button>
      </form>
    {% endif %}
  </div>
{% endif %}

{% with likes=post.get_likes %}
  {% with total=likes|length %}
    {% if total > 0 %}
      {% with first=likes.0.profile %}
        <p class="likes-line">
          Liked by
          <a href="{% url 'show_profile' first.pk %}">@{{ first.username }}</a>
          {% if total > 1 %} and {{ total|add:"-1" }} others{% endif %}
        </p>
      {% endwith %}
    {% else %}
      <p><strong>0 likes</strong></p>
    {% endif %}
  {% endwith %}
{% endwith %}

<p><h3><strong>@{{ post.profile.username }}</h3></strong>{{post.caption}}</p>
<p><strong>Timestamp:</strong> {{post.timestamp}}</p>

<h3>Comments</h3>
<ul>
  {% for c in post.get_all_comments %}
    <li>
      <strong>{{ c.profile.display_name|default:c.profile.username }}</strong>
      <small>· {{ c.timestamp }}</small>
      <div>{{ c.text }}</div>
      <br>
    </li>
  {% empty %}
    <li>No comments yet.</li>
  {% endfor %}
</ul>

{% endblock %}